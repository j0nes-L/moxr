---
import {urls as configUrls} from "../config";
interface Props {
    urls: typeof configUrls;
}
const {urls} = Astro.props;
---
<div class="container-Explorer">
    <div class="grid-Explorer" id="grid-Explorer"></div>
    <div id="load-more-container"></div>
</div>

<script>
    let allFiles = [];
    let baseUrl = '';
    let thumbnailExtension = '';
    let currentIndex = 0;

    // Detect language from <meta name="language" content="...">
    const metaLang = document.querySelector('meta[name="language"]')?.content || 'en';
    let currentLang = metaLang.toLowerCase();

    const windowWidth = window.innerWidth;
    const isMobile = windowWidth < 768;

    let initialLoadCount;
    let loadMoreCount;

    if (isMobile) {
        initialLoadCount = 3;
        loadMoreCount = 0; // No "load more" for mobile
    } else if (windowWidth < 940) {
        initialLoadCount = 6;
        loadMoreCount = 3;
    } else if (windowWidth < 1160) {
        initialLoadCount = 8;
        loadMoreCount = 4;
    } else {
        initialLoadCount = 10;
        loadMoreCount = 5;
    }

    const translations = {
        en: {
            clickToView: "click to view in 3D",
            sketchFrom: "3D-Sketch from",
            viewIn3D: "View in 3D",
            loadMore: "Load more",
            today: "today",
            yesterday: "yesterday",
            daysAgo: d => `${d} days ago`,
            weeksAgo: w => `${w} weeks ago`,
            monthsAgo: m => `${m} months ago`,
            yearsAgo: y => `${y} years ago`,
            error: "Error loading the drawings."
        },
        de: {
            clickToView: "Klicken zum 3D-Ansicht",
            sketchFrom: "3D-Skizze von",
            viewIn3D: "In 3D ansehen",
            loadMore: "Mehr laden",
            today: "heute",
            yesterday: "gestern",
            daysAgo: d => `vor ${d} Tagen`,
            weeksAgo: w => `vor ${w} Wochen`,
            monthsAgo: m => `vor ${m} Monaten`,
            yearsAgo: y => `vor ${y} Jahren`,
            error: "Fehler beim Laden der Zeichnungen."
        }
    };

    function formatFile(file) {
        const filename = file.filename;
        const parts = filename.split('_');
        const datePart = parts[1] || '';
        const timePart = parts[2] || '';
        const creatorPart = parts[3] || '';
        const year = datePart.substring(0, 4);
        const month = datePart.substring(4, 6);
        const day = datePart.substring(6, 8);

        const hour = timePart.substring(0, 2);
        const minute = timePart.substring(2, 4);

        const creator = creatorPart.replace('.glb', ' ').replaceAll('-', ' ');

        let daysAgo = '';
        if (datePart) {
            const fileDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            const today = new Date();
            fileDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            const diffTime = today.getTime() - fileDate.getTime();
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            const t = translations[currentLang] || translations.en;
            if (diffDays === 0) daysAgo = t.today;
            else if (diffDays === 1) daysAgo = t.yesterday;
            else if (diffDays < 7) daysAgo = t.daysAgo(diffDays);
            else if (diffDays < 30) daysAgo = t.weeksAgo(Math.floor(diffDays / 7));
            else if (diffDays < 365) daysAgo = t.monthsAgo(Math.floor(diffDays / 30));
            else if (diffDays >= 365) daysAgo = t.yearsAgo(Math.floor(diffDays / 365));
        }

        const thumbnailUrl = `${baseUrl}${filename.replace('.glb', thumbnailExtension)}`;
        const fileUrl = `${baseUrl}${filename}`;
        return {filename, creator, daysAgo, thumbnailUrl, fileUrl};
    }

    function appendFiles(filesToAppend) {
        const grid = document.getElementById("grid-Explorer");
        filesToAppend.forEach(file => {
            const {filename, creator, daysAgo, thumbnailUrl, fileUrl} =
                formatFile(file);

            const t = translations[currentLang] || translations.en;
            const col = document.createElement("div");
            col.className = "card-Explorer";
            col.innerHTML = `
          <a href="https://j0nes-l.github.io/moxr-glb-viewer/?file=${filename}" class="card-explorer-link" target="_blank" rel="noopener noreferrer">
            <p class="card-img-text">${t.clickToView}</p>
            <img src="${thumbnailUrl}" class="card-img-top" alt="Thumbnail for ${filename}" draggable="false" style="user-select: none; -webkit-user-drag: none;" loading="lazy" />
          </a>
          <div class="card-body">
              <div class="card-text">
              <p class="card-title" title="${filename}">${t.sketchFrom} ${daysAgo}</p>
              <p class="card-description">${creator}</p>
              <a href="https://j0nes-l.github.io/moxr-glb-viewer/?file=${filename}" class="card-explorer-btn" target="_blank" rel="noopener noreferrer">
                  <p class="card-btn-text">${t.viewIn3D}</p>
                </a>
          </div>
    `;
            grid.appendChild(col);
        });
    }

    function loadMoreFiles() {
        const filesToLoad = allFiles.slice(currentIndex, currentIndex + loadMoreCount);
        appendFiles(filesToLoad);
        currentIndex += filesToLoad.length;
        updateLoadMoreButton();
    }

    function updateLoadMoreButton() {
        const container = document.getElementById('load-more-container');
        container.innerHTML = '';

        if (!isMobile && currentIndex < allFiles.length) {
            const button = document.createElement('button');
            button.textContent = (translations[currentLang] || translations.en).loadMore;
            button.className = 'btn btn-Primary';
            button.addEventListener('click', loadMoreFiles);
            container.appendChild(button);
        }
    }

    async function loadExplorer() {
        try {
            const res = await fetch("https://00224466.xyz/MOXR/MOXRGlbExplorer.json", {cache: "no-store"});
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const data = await res.json();

            baseUrl = data.baseUrl;
            thumbnailExtension = data.thumbnailExtension;

            data.files.sort((a, b) => {
                const partsA = a.filename.split('_');
                const partsB = b.filename.split('_');

                const datePartA = partsA[1];
                const timePartA = partsA[2];
                const dateA = new Date(
                    parseInt(datePartA.substring(0, 4)),
                    parseInt(datePartA.substring(4, 6)) - 1,
                    parseInt(datePartA.substring(6, 8)),
                    parseInt(timePartA.substring(0, 2)),
                    parseInt(timePartA.substring(2, 4)),
                    parseInt(timePartA.substring(4, 6))
                );

                const datePartB = partsB[1];
                const timePartB = partsB[2];
                const dateB = new Date(
                    parseInt(datePartB.substring(0, 4)),
                    parseInt(datePartB.substring(4, 6)) - 1,
                    parseInt(datePartB.substring(6, 8)),
                    parseInt(timePartB.substring(0, 2)),
                    parseInt(timePartB.substring(2, 4)),
                    parseInt(timePartB.substring(4, 6))
                );

                return dateB - dateA; // newest first
            });

            allFiles = data.files;
            const filesToLoad = allFiles.slice(currentIndex, currentIndex + initialLoadCount);
            appendFiles(filesToLoad);
            currentIndex += filesToLoad.length;
            updateLoadMoreButton();

        } catch (err) {
            console.error(err);
            document.getElementById("grid-Explorer").innerHTML = `<p>${(translations[currentLang] || translations.en).error}</p>`;
        }
    }

    loadExplorer();
</script>